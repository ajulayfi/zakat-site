<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø²ÙƒØ§Ø© Ø§Ù„ÙØ·Ø± Ù¡Ù¤Ù¤Ù§</title>

  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
/* âœ… Ù‚ÙÙ„ Ø§Ù„Ø²Ø­Ù„Ù‚Ø© + Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø³ÙƒØ±ÙˆÙˆÙ„ (Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¯Ø§Ø®Ù„ .wrap) */
html, body{
  height:100%;
  overflow:hidden;
  overscroll-behavior:none;
}
body{
  position:fixed;     /* Ø£Ù‡Ù… Ø³Ø·Ø± Ù„Ø¥ÙŠÙ‚Ø§Ù bounce ÙÙŠ iOS */
  inset:0;
  width:100%;
  margin:0;
  padding:0;          /* Ù†Ù‚Ù„Ù†Ø§ padding Ù„Ù„Ù€ wrap */
  overflow-x:hidden;
}

    :root{
      --bg:#f4f6f8;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#6b7280;
      --line:#e5e7eb;
      --shadow:0 22px 50px rgba(2,6,23,.10);

      --green1:#0f5b3b;
      --green2:#0b3b2e;
      --green3:#22c55e;
      --greenSoft:#f4fff9;
      --greenDash:rgba(15,91,59,.35);

      --danger:#ef4444;
      --dangerSoft:rgba(239,68,68,.12);

      --r:22px;
    }

    *{box-sizing:border-box;font-family:"IBM Plex Sans Arabic",system-ui,-apple-system,Segoe UI,Arial}

    /* âœ… Ù†ÙØ³ body Ø­Ù‚Ùƒ Ù„ÙƒÙ† Ø¨Ø¯ÙˆÙ† padding Ù„Ø£Ù†Ù‡ ØµØ§Ø± Ø¹Ù„Ù‰ wrap */
    body{
      background:
        radial-gradient(900px 500px at 50% 0%, rgba(15,91,59,.10), transparent 60%),
        var(--bg);
      color:var(--text);
      display:flex;
      justify-content:center;
    }

    /* Ø²Ø®Ø±ÙØ© Ø®Ù„ÙÙŠØ© Ø®ÙÙŠÙØ© */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:0;
      opacity:.11;
      background-image:
        radial-gradient(circle at 12px 12px, rgba(15,91,59,.28) 1.3px, transparent 1.5px),
        radial-gradient(circle at 40px 40px, rgba(15,91,59,.22) 1.3px, transparent 1.5px),
        linear-gradient(135deg, rgba(15,91,59,.08) 25%, transparent 25%, transparent 50%, rgba(15,91,59,.08) 50%, rgba(15,91,59,.08) 75%, transparent 75%, transparent);
      background-size: 78px 78px, 78px 78px, 62px 62px;
      background-position: 0 0, 20px 20px, 0 0;
    }

    /* âœ… wrap ØµØ§Ø± Ù‡Ùˆ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªÙ…Ø±ÙŠØ± + Ø£Ø®Ø° padding */
    .wrap{
      width:100%;
      max-width:720px;
      position:relative;
      z-index:1;

      height:100%;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      padding:22px;
    }
    @supports (height: 100dvh){
      .wrap{ height:100dvh; }
    }

    .top{
      width:100%;
      max-width:520px;
      margin:0 auto 16px;
      background:linear-gradient(180deg,var(--green1),var(--green2));
      border-radius:26px;
      padding:18px 18px 16px;
      color:#fff;
      box-shadow:var(--shadow);
      position:relative;
      overflow:hidden;
    }

    /* Ø²Ø®Ø±ÙØ© Ù†Ù‚Ø·ÙŠØ© Ù‚Ø¯ÙŠÙ…Ø© (ØªØªØ±ÙƒÙ‡Ø§ ÙƒÙ…Ø§ Ù‡ÙŠ) */
    .top::before{
      content:"";
      position:absolute;
      inset:0;
      z-index:1;
      pointer-events:none;
      opacity:.18;
      background-image:
        radial-gradient(circle at 18px 18px, rgba(255,255,255,.26) 2px, transparent 2.2px),
        radial-gradient(circle at 18px 18px, rgba(255,255,255,.18) 9px, transparent 9.2px),
        radial-gradient(circle at 44px 44px, rgba(255,255,255,.16) 2px, transparent 2.2px),
        linear-gradient(45deg, rgba(255,255,255,.10) 25%, transparent 25%, transparent 50%, rgba(255,255,255,.10) 50%, rgba(255,255,255,.10) 75%, transparent 75%, transparent);
      background-size: 88px 88px, 88px 88px, 88px 88px, 52px 52px;
      mix-blend-mode: screen;
    }

    .top::after{
      content:"";
      position:absolute;
      inset:-160px -120px auto auto;
      width:320px;height:320px;
      background:radial-gradient(circle at 30% 30%, rgba(255,255,255,.18), transparent 62%);
      transform:rotate(10deg);
      z-index:1;
      pointer-events:none;
    }

    /* âœ… Ø²Ø®Ø±ÙØ© SVG ÙŠÙ…ÙŠÙ† ÙˆØªØ°ÙˆØ¨ (Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©) */
    .topPattern{
      position:absolute;
      inset:0;
      z-index:2;
      pointer-events:none;
      opacity:.16;
      mix-blend-mode:screen;
    }
    .topPattern svg{width:100%;height:100%;display:block}

    .topRow{
      position:relative;
      z-index:3;
      display:flex;
      gap:14px;
      justify-content:space-between;
      align-items:flex-start;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.16);
      border:1px solid rgba(255,255,255,.22);
      font-weight:800;
      font-size:12px;
      white-space:nowrap;
    }
    .title h1{margin:0;font-size:20px;font-weight:800}
    .title p{margin:6px 0 0;font-size:12.5px;opacity:.9;font-weight:600}

    .progress{
      position:relative;
      z-index:3;
      margin-top:14px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .stepDot{
      width:30px;height:30px;border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;font-size:13px;
      background:rgba(255,255,255,.16);
      border:1px solid rgba(255,255,255,.20);
      color:#fff;
    }
    .stepDot.active{
      background:var(--green3);
      border-color:var(--green3);
      color:#06301e;
      box-shadow:0 10px 26px rgba(34,197,94,.24);
    }
    .bar{flex:1;height:7px;background:rgba(255,255,255,.16);border-radius:999px;overflow:hidden}
    .barFill{display:block;height:100%;width:50%;background:linear-gradient(90deg,#22c55e,#86efac);transition:width .35s cubic-bezier(.2,.9,.2,1)}

    .card{
      width:100%;
      max-width:520px;
      margin:0 auto;
      background:var(--card);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .cardBody{padding:18px 18px 8px}

    .sectionTitle{
      display:flex;justify-content:space-between;align-items:center;
      margin:6px 0 10px;color:var(--green2);
      font-weight:900;font-size:13.5px;
    }
    .hint{font-size:12px;color:var(--muted);font-weight:700}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:520px){ .grid2{grid-template-columns:1fr} }

    .field label{display:block;font-size:12px;font-weight:800;color:var(--muted);margin:0 0 6px}
    .input{
      width:100%;
      border:1px solid var(--line);
      background:#fff;
      border-radius:16px;
      padding:14px 14px;
      font-size:14px;
      font-weight:700;
      outline:none;
      transition:.15s ease;
    }
    .input::placeholder{color:#9ca3af;font-weight:700}
    .input:focus{border-color:rgba(15,91,59,.55);box-shadow:0 0 0 4px rgba(15,91,59,.12)}
    .input[readonly]{background:#f3f4f6;color:#111827}
    .input.invalid{
      border-color:var(--danger);
      background:linear-gradient(0deg,var(--dangerSoft),transparent 60%);
      box-shadow:0 0 0 4px rgba(239,68,68,.10);
    }

    .upload{
      border:1.5px dashed var(--greenDash);
      background:var(--greenSoft);
      border-radius:16px;
      padding:14px 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      cursor:pointer;
      user-select:none;
    }
    .upload strong{color:var(--green1);font-size:13px;font-weight:900;display:block}
    .upload small{display:block;color:var(--muted);font-weight:700;margin-top:2px}
    .fileName{
      color:var(--muted);
      font-weight:800;
      font-size:12px;
      max-width:200px;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }
    .upload input{display:none}

    .actions{
      display:flex;
      gap:12px;
      padding:14px 18px 18px;
      border-top:1px solid #f1f5f9;
    }
    .btn{
      flex:1;border:none;border-radius:16px;
      padding:14px 14px;
      font-weight:900;font-size:14px;
      cursor:pointer;transition:.15s ease;
    }
    .btnPrimary{background:linear-gradient(180deg,var(--green1),var(--green2));color:#fff;box-shadow:0 14px 28px rgba(15,91,59,.22)}
    .btnSecondary{background:#f3f4f6;color:#111827;border:1px solid #e5e7eb}
    .btn:disabled{opacity:.65;cursor:not-allowed;box-shadow:none}

    .toast{
      position:fixed;bottom:22px;left:50%;
      transform:translateX(-50%);
      padding:14px 18px;border-radius:14px;
      display:none;z-index:999;
      font-weight:800;font-size:13.5px;
      box-shadow:0 18px 44px rgba(0,0,0,.18);
      backdrop-filter: blur(6px);
    }
    .toast.show{display:block;animation:toastIn .18s ease-out}
    @keyframes toastIn{
      from{opacity:.6; transform:translateX(-50%) translateY(8px)}
      to{opacity:1; transform:translateX(-50%) translateY(0)}
    }

    .footer{text-align:center;color:var(--muted);font-weight:800;font-size:12px;margin:12px auto 0;max-width:520px}

    .step{display:none}
    .step.active{display:block}

    .successWrap{padding:36px 10px 30px;text-align:center}
    .check{width:84px;height:84px;margin:0 auto;filter: drop-shadow(0 18px 30px rgba(34,197,94,.18))}
    .circle{stroke: rgba(34,197,94,1);stroke-width:6;fill: rgba(34,197,94,.10);stroke-dasharray: 260;stroke-dashoffset: 260;animation: drawCircle .6s ease-out forwards}
    .tick{stroke: rgba(34,197,94,1);stroke-width:7;fill:none;stroke-linecap:round;stroke-linejoin:round;stroke-dasharray: 90;stroke-dashoffset: 90;animation: drawTick .45s ease-out .35s forwards}
    @keyframes drawCircle{to{stroke-dashoffset:0}}
    @keyframes drawTick{to{stroke-dashoffset:0}}
    .successWrap h2{margin:12px 0 6px;font-size:18px;font-weight:900;color:var(--green2)}
    .successWrap p{margin:0;color:var(--muted);font-weight:700;font-size:13px;line-height:1.7}

    .spin{
      width:16px;height:16px;border-radius:999px;
      border:2px solid rgba(255,255,255,.35);
      border-top-color:#fff;
      display:none;
      animation: sp .8s linear infinite;
    }
    @keyframes sp{to{transform:rotate(360deg)}}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">

      <!-- âœ… Ø²Ø®Ø±ÙØ© Ø¥Ø³Ù„Ø§Ù…ÙŠØ© ÙŠÙ…ÙŠÙ† ÙˆØªØ°ÙˆØ¨ -->
      <div class="topPattern" aria-hidden="true">
        <svg viewBox="0 0 600 240" preserveAspectRatio="xMaxYMid slice">
          <defs>
            <pattern id="geo" width="120" height="120" patternUnits="userSpaceOnUse">
              <g fill="none" stroke="rgba(255,255,255,.55)" stroke-width="3">
                <path d="M60 8 L78 42 L115 42 L86 65 L98 105 L60 82 L22 105 L34 65 L5 42 L42 42 Z"/>
                <circle cx="60" cy="60" r="38"/>
              </g>
            </pattern>
            <linearGradient id="fade" x1="1" y1="0" x2="0" y2="0">
              <stop offset="0%" stop-color="#fff" stop-opacity="1"/>
              <stop offset="55%" stop-color="#fff" stop-opacity=".35"/>
              <stop offset="78%" stop-color="#fff" stop-opacity="0"/>
              <stop offset="100%" stop-color="#fff" stop-opacity="0"/>
            </linearGradient>
            <mask id="m">
              <rect width="100%" height="100%" fill="url(#fade)"/>
            </mask>
          </defs>
          <rect width="100%" height="100%" fill="url(#geo)" mask="url(#m)"/>
        </svg>
      </div>

      <div class="topRow">
        <div class="pill">25 Ø±ÙŠØ§Ù„ / ÙØ±Ø¯</div>
        <div class="title">
          <h1>Ø²ÙƒØ§Ø© Ø§Ù„ÙØ·Ø± Ù¡Ù¤Ù¤Ù§</h1>
          <p>ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ø±ÙØ§Ù‚ Ø¥ÙŠØµØ§Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„</p>
        </div>
      </div>

      <div class="progress">
        <div class="stepDot active" id="dot1">1</div>
        <div class="bar"><span class="barFill" id="barFill"></span></div>
        <div class="stepDot" id="dot2">2</div>
      </div>
    </div>

    <div class="card">
      <div class="cardBody" id="cardBody">

        <div class="step active" id="step1">
          <div class="sectionTitle">
            <span>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙÙŠØ¯</span>
            <span class="hint">Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ + Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</span>
          </div>

          <div class="grid2">
            <div class="field">
              <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„ *</label>
              <input class="input" id="first" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯" autocomplete="given-name">
            </div>
            <div class="field">
              <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ *</label>
              <input class="input" id="second" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù†">
            </div>
            <div class="field">
              <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ø§Ù„Ø« *</label>
              <input class="input" id="third" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡">
            </div>
            <div class="field">
              <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø§Ø¨Ø¹ *</label>
              <input class="input" id="fourth" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ²">
            </div>
          </div>

          <div class="field" style="margin-top:2px">
            <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</label>
            <input class="input" value="Ø§Ù„Ø¬Ù„ÙŠÙÙŠ" readonly>
          </div>

          <div class="field">
            <label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ *</label>
            <input class="input" id="phone" inputmode="numeric" placeholder="05xxxxxxxx">
          </div>
        </div>

        <div class="step" id="step2">
          <div class="sectionTitle">
            <span>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø²ÙƒØ§Ø©</span>
            <span class="hint">Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØ¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„</span>
          </div>

          <div class="grid2">
            <div class="field">
              <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙØ±Ø§Ø¯ *</label>
              <input class="input" id="people" type="text" inputmode="numeric" autocomplete="off" placeholder="Ù…Ø«Ø§Ù„: 5">
            </div>
            <div class="field">
              <label>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</label>
              <input class="input" id="total" readonly placeholder="ÙŠÙØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§">
            </div>

            <div class="field">
              <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ *</label>
              <input class="input" id="paid" type="text" inputmode="decimal" autocomplete="off" placeholder="ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø£Ø¹Ù„Ù‰ Ù…Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ">
            </div>
            <div class="field">
              <label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­ÙˆÙŠÙ„ *</label>
              <input class="input" id="transferDate" type="date">
            </div>
          </div>

          <div class="field">
            <label>Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ù…Ø­ÙˆÙ„ Ù…Ù†Ù‡ *</label>
            <input class="input" id="bank" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ">
          </div>

          <div class="field">
            <label>Ø¥Ø±ÙØ§Ù‚ Ø¥ÙŠØµØ§Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„ *</label>
            <label class="upload">
              <div>
                <strong>ğŸ“ Ø¥Ø±ÙØ§Ù‚ Ø¥ÙŠØµØ§Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„</strong>
                <small>ØµÙˆØ±Ø© Ø£Ùˆ PDF</small>
              </div>
              <div class="fileName" id="fileName">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</div>
              <input id="receipt" type="file" accept="image/*,application/pdf">
            </label>
          </div>
        </div>

      </div>

      <div class="actions" id="actions">
        <button class="btn btnPrimary" id="primaryBtn" type="button">
          <span class="spin" id="spin"></span>
          <span id="primaryText">Ø§Ù„ØªØ§Ù„ÙŠ</span>
        </button>
        <button class="btn btnSecondary" id="secondaryBtn" type="button" style="display:none">Ø±Ø¬ÙˆØ¹</button>
      </div>
    </div>

    <div class="footer">ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ù„Ø®Ø¯Ù…Ø© Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø²ÙƒØ§Ø© Ø§Ù„ÙØ·Ø±</div>
  </div>

  <div class="toast" id="toast"></div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwQP0FiCNR73ff4dZgJWFWSU9CknFDmUCE1wLxxZObw3DruqVFB9yUfJ4pKFU5jFvJEFw/exec";
  const PRICE = 25;
  const $ = (id)=>document.getElementById(id);

  const step1 = $("step1"), step2 = $("step2");
  const dot1 = $("dot1"), dot2 = $("dot2"), barFill = $("barFill");
  const primaryBtn = $("primaryBtn"), secondaryBtn = $("secondaryBtn");
  const primaryText = $("primaryText"), spin = $("spin");

  const first = $("first"), second = $("second"), third = $("third"), fourth = $("fourth"), phone = $("phone");
  const people = $("people"), total = $("total"), paid = $("paid"), transferDate = $("transferDate"), bank = $("bank");
  const receipt = $("receipt"), fileName = $("fileName");

  function showToast(text, type="error"){
    const t = $("toast");
    const styles = {
      success: { bg:"#062B1A", fg:"#ECFDF5", bd:"rgba(34,197,94,.35)" },
      warn:    { bg:"#2A1D06", fg:"#FFFBEB", bd:"rgba(245,158,11,.35)" },
      error:   { bg:"#2A0B0B", fg:"#FEF2F2", bd:"rgba(239,68,68,.35)" },
      info:    { bg:"#0B1220", fg:"#EEF2FF", bd:"rgba(148,163,184,.35)" }
    };
    const s = styles[type] || styles.error;
    t.style.background = s.bg;
    t.style.color = s.fg;
    t.style.border = `1px solid ${s.bd}`;
    t.textContent = text;
    t.classList.add("show");
    clearTimeout(t._timer);
    t._timer = setTimeout(()=>t.classList.remove("show"), 3200);
  }

  function setLoading(v){
    primaryBtn.disabled = v;
    spin.style.display = v ? "inline-block" : "none";
  }

  function clearInvalid(){
    document.querySelectorAll(".input.invalid").forEach(el=>el.classList.remove("invalid"));
  }
  function markInvalid(el){
    el.classList.add("invalid");
    el.focus({preventScroll:true});
  }

  function toEnglishDigits(str){
    const map = {
      "Ù ":"0","Ù¡":"1","Ù¢":"2","Ù£":"3","Ù¤":"4","Ù¥":"5","Ù¦":"6","Ù§":"7","Ù¨":"8","Ù©":"9",
      "Û°":"0","Û±":"1","Û²":"2","Û³":"3","Û´":"4","Ûµ":"5","Û¶":"6","Û·":"7","Û¸":"8","Û¹":"9"
    };
    return String(str||"").replace(/[Ù -Ù©Û°-Û¹]/g, d => map[d] ?? d);
  }

  function normalizePhone(p){
    p = toEnglishDigits(p || "").trim().replace(/\s+/g,"").replace(/-/g,"");
    const digits = p.replace(/\D/g,"");
    if (/^05\d{8}$/.test(digits)) return "+966" + digits.slice(1);
    if (/^5\d{8}$/.test(digits))  return "+966" + digits;
    if (/^9665\d{8}$/.test(digits)) return "+966" + digits.slice(3);
    if (/^\+9665\d{8}$/.test(p)) return p;
    return null;
  }

  function toNumber(v){
    const n = Number(toEnglishDigits(String(v ?? "")).replace(/,/g,"").trim());
    return Number.isFinite(n) ? n : 0;
  }

  function calcTotal(){
    const p = Math.max(0, Math.floor(toNumber(people.value)));
    total.value = p ? String(p * PRICE) : "";
  }

  function setStep(n){
    clearInvalid();
    if(n===1){
      step1.classList.add("active"); step2.classList.remove("active");
      dot1.classList.add("active"); dot2.classList.remove("active");
      barFill.style.width = "50%";
      primaryText.textContent = "Ø§Ù„ØªØ§Ù„ÙŠ";
      secondaryBtn.style.display = "none";
    }else{
      step1.classList.remove("active"); step2.classList.add("active");
      dot2.classList.add("active"); dot1.classList.remove("active");
      barFill.style.width = "100%";
      primaryText.textContent = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨";
      secondaryBtn.style.display = "inline-block";
      calcTotal();
    }

    /* âœ… Ø¨Ø¯Ù„ window.scrollTo Ù„Ø£Ù† Ø§Ù„Ø³ÙƒØ±ÙˆÙˆÙ„ ØµØ§Ø± Ø¯Ø§Ø®Ù„ .wrap */
    document.querySelector(".wrap").scrollTo({ top: 0, behavior: "smooth" });
  }

  function showSuccessPage(){
    $("actions").style.display = "none";
    $("cardBody").innerHTML = `
      <div class="successWrap">
        <svg class="check" viewBox="0 0 100 100" aria-hidden="true">
          <circle class="circle" cx="50" cy="50" r="40"></circle>
          <path class="tick" d="M32 52 L45 64 L70 38"></path>
        </svg>
        <h2>ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ âœ…</h2>
        <p>Ø´ÙƒØ±Ù‹Ø§ Ù„Ùƒ.</p>
      </div>
    `;
  }

  function validateStep1(){
    clearInvalid();
    if(!first.value.trim()){ showToast("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„", "error"); markInvalid(first); return false; }
    if(!second.value.trim()){ showToast("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ", "error"); markInvalid(second); return false; }
    if(!third.value.trim()){ showToast("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ø§Ù„Ø«", "error"); markInvalid(third); return false; }
    if(!fourth.value.trim()){ showToast("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø§Ø¨Ø¹", "error"); markInvalid(fourth); return false; }

    phone.value = toEnglishDigits(phone.value).replace(/[^\d]/g,"").slice(0,10);
    if(!/^05\d{8}$/.test(phone.value)){
      showToast("Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 05 ÙˆÙŠØªÙƒÙˆÙ† Ù…Ù† 10 Ø£Ø±Ù‚Ø§Ù…", "error");
      markInvalid(phone);
      return false;
    }
    return true;
  }

  function validateStep2(){
    clearInvalid();
    calcTotal();

    people.value = toEnglishDigits(people.value).replace(/[^\d]/g,"");
    paid.value   = toEnglishDigits(paid.value).replace(/[^0-9.]/g,"").replace(/-/g,"");

    if(!people.value || Number(people.value) < 1){
      showToast("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ Ø£ÙØ±Ø§Ø¯ ØµØ­ÙŠØ­", "error");
      markInvalid(people);
      return false;
    }

    const t = toNumber(total.value);
    const p = toNumber(paid.value);

    if(p <= 0){
      showToast("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹", "error");
      markInvalid(paid);
      return false;
    }
    if(p < t){
      showToast(`Ø§Ù„Ù…Ø¨Ù„Øº Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (${t} Ø±ÙŠØ§Ù„)`, "error");
      markInvalid(paid);
      return false;
    }

    if(!transferDate.value){
      showToast("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­ÙˆÙŠÙ„", "error");
      markInvalid(transferDate);
      return false;
    }

    if(!bank.value.trim()){
      showToast("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ", "error");
      markInvalid(bank);
      return false;
    }

    const file = receipt.files && receipt.files[0];
    if(!file){
      showToast("ÙŠØ±Ø¬Ù‰ Ø¥Ø±ÙØ§Ù‚ Ø¥ÙŠØµØ§Ù„ (ØµÙˆØ±Ø© Ø£Ùˆ PDF)", "error");
      return false;
    }

    const okMime =
      (file.type || "").startsWith("image/") ||
      (file.type === "application/pdf") ||
      (String(file.name||"").toLowerCase().endsWith(".pdf"));

    if(!okMime){
      showToast("Ø§Ù„Ù…Ù„Ù ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ØµÙˆØ±Ø© Ø£Ùˆ PDF", "error");
      return false;
    }

    return true;
  }

  async function postToApi(data){
    const res = await fetch(SCRIPT_URL,{
      method:"POST",
      headers:{ "Content-Type":"application/x-www-form-urlencoded" },
      body:new URLSearchParams(data)
    });
    const text = await res.text();
    try { return JSON.parse(text); }
    catch { return { status:"unknown", raw:text }; }
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    const today = new Date().toISOString().split("T")[0];
    transferDate.setAttribute("max", today);

    document.querySelectorAll("input").forEach(input=>{
      input.addEventListener("input", ()=>{
        const pos = input.selectionStart ?? null;
        input.value = toEnglishDigits(input.value);
        if(pos !== null){
          try{ input.setSelectionRange(pos, pos); }catch(e){}
        }
      });
    });

    people.addEventListener("input", ()=>{
      const pos = people.selectionStart ?? null;
      people.value = toEnglishDigits(people.value).replace(/[^\d]/g,"");
      if(pos !== null){
        const p = Math.min(pos, people.value.length);
        try{ people.setSelectionRange(p,p); }catch(e){}
      }
      calcTotal();
    });

    paid.addEventListener("input", ()=>{
      const pos = paid.selectionStart ?? null;
      let v = toEnglishDigits(paid.value).replace(/[^0-9.]/g,"").replace(/-/g,"");
      const parts = v.split(".");
      if(parts.length > 2) v = parts[0] + "." + parts.slice(1).join("");
      paid.value = v;
      if(pos !== null){
        const p = Math.min(pos, paid.value.length);
        try{ paid.setSelectionRange(p,p); }catch(e){}
      }
    });

    phone.addEventListener("input", ()=>{
      const pos = phone.selectionStart ?? null;
      phone.value = toEnglishDigits(phone.value).replace(/[^\d]/g,"").slice(0,10);
      if(pos !== null){
        const p = Math.min(pos, phone.value.length);
        try{ phone.setSelectionRange(p,p); }catch(e){}
      }
    });

    receipt.addEventListener("change", ()=>{
      const f = receipt.files && receipt.files[0];
      fileName.textContent = f ? f.name : "Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù";
    });

    primaryBtn.addEventListener("click", async ()=>{
      if(step1.classList.contains("active")){
        if(!validateStep1()) return;
        setStep(2);
        return;
      }

      if(!validateStep1()){ setStep(1); return; }
      if(!validateStep2()) return;

      const file = receipt.files[0];
      setLoading(true);

      try{
        const base64 = await new Promise((resolve,reject)=>{
          const fr = new FileReader();
          fr.onloadend = ()=> resolve(String(fr.result).split(",")[1] || "");
          fr.onerror = reject;
          fr.readAsDataURL(file);
        });

        const ph = normalizePhone(phone.value);
        const t = toNumber(total.value);
        const p = toNumber(paid.value);

        const payload = {
          first: first.value.trim(),
          second: second.value.trim(),
          third: third.value.trim(),
          fourth: fourth.value.trim(),
          phone: ph,
          people: String(Math.floor(toNumber(people.value))),
          total: String(t),
          paid: String(p),
          transferDate: transferDate.value,
          bank: bank.value.trim(),
          image: base64,
          mimeType: file.type || (String(file.name||"").toLowerCase().endsWith(".pdf") ? "application/pdf" : "image/jpeg")
        };

        const result = await postToApi(payload);

        if(result.status === "success"){
          showSuccessPage();
          showToast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ âœ…", "success");
        }else if(result.status === "duplicate"){
          showToast("Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§.", "warn");
        }else if(result.status === "invalid_phone"){
          showToast("Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ØºÙŠØ± ØµØ­ÙŠØ­.", "error");
          setStep(1);
        }else if(result.status === "paid_less"){
          showToast("Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ.", "error");
        }else{
          showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", "error");
          console.log("API result:", result);
        }

      }catch(e){
        showToast("ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„ØµÙØ­Ø© Ù…Ø³ØªØ¶Ø§ÙØ© ÙˆÙ„ÙŠØ³Øª file://", "error");
        console.error(e);
      }finally{
        setLoading(false);
      }
    });

    secondaryBtn.addEventListener("click", ()=> setStep(1));
    setStep(1);
  });
</script>
</body>
</html>